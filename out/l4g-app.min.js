define(["packages/underscore","packages/jquery","packages/backbone"],function(e,n,t){var i,o,c;return function(e){function n(e,n){return v.call(e,n)}function t(e,n){var t,i,o,c,r,s,a,u,l,f,d,g=n&&n.split("/"),h=E.map,p=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(n){for(g=g.slice(0,g.length-1),e=e.split("/"),r=e.length-1,E.nodeIdCompat&&S.test(e[r])&&(e[r]=e[r].replace(S,"")),e=g.concat(e),l=0;l<e.length;l+=1)if(d=e[l],"."===d)e.splice(l,1),l-=1;else if(".."===d){if(1===l&&(".."===e[2]||".."===e[0]))break;l>0&&(e.splice(l-1,2),l-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((g||p)&&h){for(t=e.split("/"),l=t.length;l>0;l-=1){if(i=t.slice(0,l).join("/"),g)for(f=g.length;f>0;f-=1)if(o=h[g.slice(0,f).join("/")],o&&(o=o[i])){c=o,s=l;break}if(c)break;!a&&p&&p[i]&&(a=p[i],u=l)}!c&&a&&(c=a,s=u),c&&(t.splice(0,s,c),e=t.join("/"))}return e}function r(n,t){return function(){var i=_.call(arguments,0);return"string"!=typeof i[0]&&1===i.length&&i.push(null),g.apply(e,i.concat([n,t]))}}function s(e){return function(n){return t(n,e)}}function a(e){return function(n){T[e]=n}}function u(t){if(n(m,t)){var i=m[t];delete m[t],b[t]=!0,d.apply(e,i)}if(!n(T,t)&&!n(b,t))throw new Error("No "+t);return T[t]}function l(e){var n,t=e?e.indexOf("!"):-1;return t>-1&&(n=e.substring(0,t),e=e.substring(t+1,e.length)),[n,e]}function f(e){return function(){return E&&E.config&&E.config[e]||{}}}var d,g,h,p,T={},m={},E={},b={},v=Object.prototype.hasOwnProperty,_=[].slice,S=/\.js$/;h=function(e,n){var i,o=l(e),c=o[0];return e=o[1],c&&(c=t(c,n),i=u(c)),c?e=i&&i.normalize?i.normalize(e,s(n)):t(e,n):(e=t(e,n),o=l(e),c=o[0],e=o[1],c&&(i=u(c))),{f:c?c+"!"+e:e,n:e,pr:c,p:i}},p={require:function(e){return r(e)},exports:function(e){var n=T[e];return"undefined"!=typeof n?n:T[e]={}},module:function(e){return{id:e,uri:"",exports:T[e],config:f(e)}}},d=function(t,i,o,c){var s,l,f,d,g,E,v=[],_=typeof o;if(c=c||t,"undefined"===_||"function"===_){for(i=!i.length&&o.length?["require","exports","module"]:i,g=0;g<i.length;g+=1)if(d=h(i[g],c),l=d.f,"require"===l)v[g]=p.require(t);else if("exports"===l)v[g]=p.exports(t),E=!0;else if("module"===l)s=v[g]=p.module(t);else if(n(T,l)||n(m,l)||n(b,l))v[g]=u(l);else{if(!d.p)throw new Error(t+" missing "+l);d.p.load(d.n,r(c,!0),a(l),{}),v[g]=T[l]}f=o?o.apply(T[t],v):void 0,t&&(s&&s.exports!==e&&s.exports!==T[t]?T[t]=s.exports:f===e&&E||(T[t]=f))}else t&&(T[t]=o)},i=o=g=function(n,t,i,o,c){if("string"==typeof n)return p[n]?p[n](t):u(h(n,t).f);if(!n.splice){if(E=n,E.deps&&g(E.deps,E.callback),!t)return;t.splice?(n=t,t=i,i=null):n=e}return t=t||function(){},"function"==typeof i&&(i=o,o=c),o?d(e,n,t,i):setTimeout(function(){d(e,n,t,i)},4),g},g.config=function(e){return g(e)},i._defined=T,c=function(e,t,i){t.splice||(i=t,t=[]),n(T,e)||n(m,e)||(m[e]=[e,t,i])},c.amd={jQuery:!0}}(),c("../node_modules/almond/almond",function(){}),c("backend/utils",[],function(){return{signatures:{OPERA:"opera",OPERA_NEXT:"opr",FIREFOX:"mozilla",GOOGLE_CHROME:"chrome",YANDEX_BROWSER:"yabrowser",INTERNET_EXPLORER:"msie"},getBrowserUASignature:function(){var e=window.navigator.userAgent.toLowerCase(),n=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(yabrowser)[ \/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.test(e)&&["trident","msie"]||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return n[5]||n[3]||n[1]||""}}}),c("backend/abstract",["packages/underscore","packages/jquery","packages/backbone"],function(e,n,t){return e.extend({STATE_IDLE:"idle",STATE_CONNECTING:"connecting",STATE_OPEN:"open",STATE_ERROR:"error",_enabled:!0,_accel:!1,_state:"idle",_config:{},_errorMessage:null,_error:function(e){this._state=this.STATE_ERROR,this._errorMessage=e,"undefined"!=typeof console&&console.error&&console.error(e),this.trigger("error",e)},enabled:function(e){return arguments.length&&(e=!!e,e!==this._enabled&&(this._enabled=e,this.trigger(this._enabled?"enable":"disable"))),this._enabled},enable:function(){return this.enabled(!0),this},disable:function(){return this.enabled(!1),this},state:function(){return this._state},connect:function(){console.error("Not implemented!")},disconnect:function(){console.error("Not implemented!")},accelerate:function(e){e=!!e,e!==this._accel&&(this._accel=e,this.trigger("accelerate",e))},send:function(n,t){t=t||{},this.trigger("send",{name:n,data:t}),e.isObject(t)&&(t=JSON.stringify(t)),this.state()===this.STATE_OPEN&&this._send(n,t)},available:function(){return n.Deferred().resolve(this)},_send:function(){console.error("Not implemented!")},config:function(n,t){if("object"==typeof n)return void e.each(n,function(e,n){this._config[n]=e},this);if(arguments.length>1&&(this._config[n]=t),this._accel){var i="accel"+n.charAt(0).toUpperCase()+n.substr(1);if(i in this._config)return this._config[i]}return this._config[n]},setup:function(e){return e&&this.config(e),this.on("connect",function(){this._state=this.STATE_OPEN}).on("disconnect",function(){this._state=this.STATE_IDLE}).on("disable",function(){this.enabled(!1),this.disconnect()})},log:function(e){this.trigger("log",this.id,e)}},t.Events)}),c("backend/plugin",["packages/underscore","packages/jquery","./abstract"],function(e,n,t){function i(){navigator.plugins&&navigator.plugins.refresh(!1)}function o(){var e=h.config("reconnectTimeout");h.log("init reconnect"),e&&(u=setTimeout(function(){h.connect()},e))}function c(e,t){l.addEventListener?l.addEventListener(e,t,!1):l.attachEvent&&l.attachEvent("on"+e,t),n(l).on("fakeMessage",function(e,n,i){t.call(this,n,i)})}function r(){return window.ActiveXObject?!!s():navigator.plugins?!!e.find(navigator.mimeTypes,function(e){return e.type==d&&e.enabledPlugin}):!1}function s(){try{return new ActiveXObject(g)}catch(e){return!1}}function a(){if(window.ActiveXObject)return s();var e=document.getElementById("PluginHere");return e||(e=document.createElement("div"),e.id="PluginHere",document.body.appendChild(e)),e.innerHTML='<object id="'+f+'" type="'+d+'" width="1" height="1"><param name="onload" value="__nativePluginOnload" /></object>',document.getElementById(f)}var u,l,f="plugin4game",d="application/x-4game-plugin",g="4game.plugin.1",h=e.defaults({id:"plugin",connect:function(){u&&(clearTimeout(u),u=null),this.enabled()&&this.state()===this.STATE_IDLE&&(this._state=this.STATE_CONNECTING,this.log("trying to connect"),this.available().then(function(){function e(){l=a(),l&&l.valid?window.__nativePluginOnload():(h._state=h.STATE_IDLE,h.trigger("failed"),o())}"interactive"!==document.readyState&&"complete"!==document.readyState?document.addEventListener("DOMContentLoaded",e):e()}.bind(this)).fail(function(){this.log("not available"),this._state=this.STATE_IDLE,this.trigger("failed")}.bind(this)))},disconnect:function(){l&&(l=null),this.trigger("disconnect"),this.connect()},available:function(){return r()?n.Deferred().resolve(this):n.Deferred().reject()},refresh:function(){i()},_send:function(e,n){l.send(e,n)}},t).setup({reconnectTimeout:5e3,accelReconnectTimeout:1e3});return window.__nativePluginOnload=function(){h.enabled()&&(h.state()!=h.STATE_OPEN?(c("message",function(){h.trigger.apply(h,arguments)}),h.trigger("connect")):h.log("already connected"),n(document).trigger("pluginInited",{plugin:l}))},h}),c("backend/websocket",["packages/underscore","./abstract"],function(e,t){function i(){var n=m.config("host"),t=m.config("port"),i=e.template(m.config("url")),o=[];return e.isArray(n)||(n=[n]),e.isArray(t)||(t=[t]),e.each(n,function(n){e.each(t,function(e){o.push(i({host:n,port:e}))})}),o}function o(){if(!p||!p.length)return m._state=m.STATE_IDLE,m.log("init reconnect"),m.trigger("failed"),void(g=setTimeout(function(){m.connect()},m.config("reconnectTimeout")));if(!m.enabled())return p.length=0;for(var e=p.length,n=function(n,t){m.log("connection success ("+e+")",n,d),d?n.close(m.STATUS_CONNECTION_ESTABLISHED,JSON.stringify({name:"status",data:{desc:m.desctiptions[m.STATUS_CONNECTION_ESTABLISHED]}})):(d=n,d.onopen=a,d.onmessage=u,d.onclose=l,d.onerror=f,a(t))},t=function(n){m.log("connection error ("+e+")",n),d||--e-1||(m._state=m.STATE_IDLE,s(),h=setTimeout(r,m.config("resetTimeout")))},i=0,o=p.length;o>i;i++)c(p[i],n,t)}function c(e,n,t){var i,o,c=function(){o&&clearTimeout(o),i&&(i.onopen=i.onclose=i.onerror=null),"function"==typeof n&&n.apply(this,arguments)},r=function(e,n){o&&clearTimeout(o),e&&(e.onopen=e.onclose=e.onerror=null,(e.readyState===e.OPEN||e.readyState===e.CONNECTING)&&(n?e.close(m.STATUS_CLOSED_BY_PEER,JSON.stringify({name:"status",data:{desc:m.desctiptions[m.STATUS_CLOSED_BY_PEER]}})):e.close(m.STATUS_CONNECTION_TIMEOUT,JSON.stringify({name:"status",data:{desc:m.desctiptions[m.STATUS_CONNECTION_TIMEOUT]}})))),"function"==typeof t&&t.apply(this,arguments)};try{m.log("trying ",e),i=new WebSocket(e),i.onopen=function(e){c(i,e)},i.onclose=i.onerror=function(e){r(i,e)},o=setTimeout(function(){r(i)},T)}catch(s){m._error(s),r(i,s)}}function r(){d&&d.readyState!=WebSocket.CONNECTING||(m.log("reset on timeout"),d&&(d.close(m.STATUS_CONNECTION_TIMEOUT,JSON.stringify({name:"status",data:{desc:m.desctiptions[m.STATUS_CONNECTION_TIMEOUT]}})),d=null),m.trigger("failed"),m.connect())}function s(){h&&(clearTimeout(h),h=null)}function a(){s(),m.log("connected to",d.url),m.enabled()?m.trigger("connect"):m.disconnect()}function u(e){m.enabled()&&e.data&&m.trigger("message",e.data)}function l(e){var n=d||e.target;return m.log("before closing status",n.readyState),n.readyState===WebSocket.OPEN?m.log("crazy browser! tries to close opened connection! aborting..."):(m.log("closing connection"),n.onopen=n.onmessage=n.onclose=n.onerror=null,void(m.state()===m.STATE_OPEN?m.disconnect():(s(),o())))}function f(e){s(),m.log("connection error",e)}var d,g,h,p=[],T=2e3,m=e.defaults({id:"ws",STATUS_CONNECTION_TIMEOUT:4e3,STATUS_CLOSED_BY_PEER:4001,STATUS_CONNECTION_ESTABLISHED:4002,desctiptions:{4e3:"connection timeout",4001:"connection closed by peer",4002:"another connection already established"},connect:function(){g&&(clearTimeout(g),g=null),this.enabled()&&this.state()===this.STATE_IDLE&&this.available().then(function(){this._state=this.STATE_CONNECTING,p=i(),o()}.bind(this)).fail(function(){this._error("WebSockets are not available for this browser")}.bind(this))},disconnect:function(){d&&d.readyState==d.OPEN&&d.close(this.STATUS_CLOSED_BY_PEER,JSON.stringify({name:"status",data:{desc:this.desctiptions[this.STATUS_CLOSED_BY_PEER]}})),d=null,s(),this.trigger("disconnect"),this.connect()},available:function(){return null!=window.WebSocket?n.Deferred().resolve(this):n.Deferred().reject()},_send:function(e,n){d&&d.readyState==d.OPEN&&d.send(JSON.stringify({name:e,data:n}))}},t).setup({url:"wss://<%= host %>:<%= port %>/ws",host:["127.0.0.1","localhost"],port:[853,9443,9444,9445,16853],reconnectTimeout:1e4,accelReconnectTimeout:1e3,resetTimeout:3e3});return m.on("disable",function(){this.disconnect()}),m}),c("backend/extension",["packages/underscore","packages/jquery","./abstract"],function(e,n,t){function i(){var e=l.config("reconnectTimeout");l.log("init reconnect"),e&&(s=setTimeout(function(){l.connect()},e))}function o(){var e=n.Deferred();return a?c("getAvailabilityStatus",function(n){n?e.reject():e.resolve(l)}):e.reject(),e.promise()}function c(e,n,t){var i,o,c={name:"forgame-site-message",command:e};"function"==typeof n&&(t=n,n=null),n&&(c.data=n),"function"==typeof t&&(o=Date.now(),c.id=o,i=setTimeout(function(){delete u[o],t("Timeout")},l.config("extensionTimeout")),u[o]=function(e){clearTimeout(i),delete u[o],t(null,e)}),window.postMessage(JSON.stringify(c),window.location.origin)}function r(e){if("string"==typeof e.data)try{var n,t=JSON.parse(e.data||"{}");if(e.source===window&&"forgame-extension-message"===t.name){var i=t.id;i&&u[i]?u[i](t.data):l.state()===l.STATE_OPEN&&(n=t.data||{},n="string"!=typeof n?JSON.stringify(n):n,l.trigger("message",n))}}catch(o){l.log(o.message)}}var s,a=navigator.userAgent.toLowerCase().indexOf("chrome")>=0&&navigator.vendor.toLowerCase().indexOf("google")>=0,u={};window.addEventListener("message",r);var l=e.defaults({id:"chrome-extension",connect:function(){s&&(clearTimeout(s),s=null),this.enabled()&&this.state()===this.STATE_IDLE&&(this._state=this.STATE_CONNECTING,this.log("trying to connect"),this.available().then(l.onInited.bind(this),l.onFailed.bind(this)))},available:function(){return o()},onInited:function(){l.trigger("connect")},onFailed:function(){l._state=l.STATE_IDLE,l.trigger("failed",this.id),i()},disconnect:function(){this.trigger("disconnect"),this.connect()},_send:function(e,n){c("send",{name:e,data:n})}},t).setup({reconnectTimeout:5e3,accelReconnectTimeout:1e3,extensionTimeout:2e3});return l}),c("backend/fake",["packages/underscore","./abstract"],function(e,n){return e.defaults({id:"fake",connect:function(){this.enabled()&&this.state()===this.STATE_IDLE&&(this._state=this.STATE_CONNECTING,this.log("trying to connect"),window.FOURGE&&window.FOURGE.fakePluginAvailable?this.trigger("connect"):(this.log("not available"),this._state=this.STATE_IDLE))},disconnect:function(){this.trigger("disconnect"),this.connect()},_send:function(e,n){if("string"==typeof n)try{n=JSON.parse(n)}catch(t){}this.trigger("message",JSON.stringify({name:e,data:n}))}},n).setup()}),c("backend/manager",["packages/underscore","packages/backbone","packages/jquery","./utils","./plugin","./websocket","./extension","./fake"],function(e,n,t,i,o,c,r,s){function a(e,n){M.trigger("backend-log",e,n)}function u(n){return e.isString(n)?e.find(A,function(e){return e.id===n}):n}function l(){return y&&this.id==o.id?void this.trigger("unsupported"):(e.include(D,this.id)||D.push(this.id),j&&M.resetUnlimitedReconnections(),e.invoke(A,"accelerate",!1),M.trigger("connect",this.id),P[this.id]=0,this.id!==s.id&&v(this.id+"-is-connected"),void(e.include(D,w)&&e.each(A,function(e){e.id!==w&&e.disable()})))}function f(){D=e.without(D,this.id),M.trigger("disconnect",this.id),D.length||(T(),x=setTimeout(function(){M.connect()},R))}function d(){if(e.include(D,this.id)&&u(this.id).enabled()){var n=["message"].concat(e.toArray(arguments));M.trigger.apply(M,n)}}function g(e){var n=u(M.getActiveBackend());n&&n.send(e.name,e.data)}function h(){switch(this.id){case"chrome-extension":o.available().then(function(){M.trigger("unsupported",this.id)}.bind(this)).always(function(){m(this),M.connect()}.bind(this))}}function p(){var n=++P[this.id];switch(this.id){case"ws":if(!j)if(n===B){v("ws-failed-to-connect-first-round");var t=y?r:o;e.include(A,t)||(this.disable(),A=e.without(A,this),E(t),M.connect())}else n>2*B&&(m(this),v("ws-failed-to-connect-second-round"));break;case"plugin":j?M.getActiveBackend()||this.refresh():n===B&&(v("plugin-failed-to-connect"),this.available().then(function(){M.trigger("unable-to-connect-to-available-plugin"),M.reconnectUntilSucceed()}.bind(this)).fail(function(){m(this),v("user-does-not-have-l4g-app")}.bind(this)));break;case"chrome-extension":v("extension-failed-to-connect"),this.available().then(function(){M.trigger("unable-to-connect-to-available-chrome-extension"),M.reconnectUntilSucceed()}.bind(this)).fail(function(){this.trigger("unsupported"),m(this)}.bind(this))}this.log("attempt #"+n+" has failed.")}function T(){x&&clearTimeout(x)}function m(n){n&&(O(n).disable(),A=e.without(A,n))}function E(e){if(e){if(k&&"ws"==e.id)return;S(O(e)),b(e)&&A.unshift(e)}}function b(n){return!e.include(A,n)}function v(e){M.trigger("stat",e)}function _(e){if(!U.length)return g(e);var n=U.slice(0),t=function(i){if(!i){if(!n.length)return g(e);var o=n.shift();o.length>1?o(e,t):t(null===o(e))}};t()}function S(e){return e&&e.on("connect",l).on("disconnect",f).on("failed",p).on("message",d).on("log",a).on("unsupported",h),e}function O(e){return e&&e.off("connect",l).off("disconnect",f).off("failed",p).off("message",d).off("log",a).off("unsupported",h),e}var w,A=[],N=i.getBrowserUASignature(),y=[i.signatures.GOOGLE_CHROME].indexOf(N)>=0,k=N===i.signatures.OPERA,C=function(e){var n=t.Deferred();return e?e.available().always(n.resolve):n.resolve(!1),n.promise()},I=t.Deferred(),L=[!k&&c,!y&&o,r,s];t.when.apply(null,L.map(C)).then(function(e,n,t){Array.prototype.slice.call(arguments,0).forEach(function(e){e&&A.push(e)}),e&&(m(n),m(t)),w=A[0].id,I.resolve(A)});var x,D=[],U=[],R=1e3,P={ws:0,plugin:0},j=!1,B=2,M=e.extend({connected:function(){return!!D.length},connect:function(n){I.then(function(){T(),null!=n&&u(n)&&(w=n),this.getActiveBackend()!=w&&(this.disconnect(),e.invoke(A,"enable"),e.invoke(A,"connect"))}.bind(this))},disconnect:function(){var n;e.each(D,function(e){n=u(e),n&&n.disconnect()})},send:function(e,n){_({name:e,data:n}),this.trigger("send",e,n)},accelerate:function(){var n=!!this.getActiveBackend();n||(this.reconnectUntilSucceed(),E(c),E(o)),e.invoke(A,"accelerate",!0),n||this.connect()},getActiveBackend:function(){return D[0]},addFilter:function(n){e.include(U,n)||U.push(n)},removeFilter:function(n){U=e.without(U,n)},refresh:function(){var e=this.getActiveBackend(),n=this.getBackend(e);if(e)switch(e){case"plugin":if(k)return this.disconnect(),m(n),void M.trigger("broken",n.id);default:"function"==typeof n.refresh&&n.refresh()}this.trigger("refresh",e,n)},reconnectUntilSucceed:function(){j||(j=!0)},resetUnlimitedReconnections:function(){j&&(j=!1)},updateConfig:function(e,n){var t=this.getBackend(e);t&&(t.config(n),P[t.id]=0,t.disconnect())},getBackend:u},n.Events);return I.then(function(){e.each(A,S)}),M}),c("application",["packages/underscore","./backend/manager"],function(e,n){function t(){var e=i.FAULT,t=n.getActiveBackend();switch(t){case"plugin":case"ws":case"chrome-extension":e=i.NORMAL;break;case"fake":e=i.FAKE}c(e)}var i={FAKE:"FAKE",NORMAL:"NORMAL",SAFE:"SAFE",FAULT:"FAULT",NEED_UPDATE:"NEED_UPDATE"},o=i.FAULT,c=function(){var t=e.throttle(function(){n.trigger("working-mode",o),o==i.NORMAL&&(n.send("getVersions"),n.send("getStatus"))},500);return function(e){if(!i[e])throw"Not correct working mode: "+e;o=i[e],t()}}();return{version:3,backend:n,WORKING_MODE:i,setWorkingMode:c,getWorkingMode:function(){return o},init:function(){c(o),n.on("connect",t).on("disconnect",function(){this.connected()?t.call(this):c(i.FAULT)}).trigger("started","L4G: Module Plugin").connect()}}}),c("packages/underscore",function(){return e}),c("packages/jquery",function(){return n}),c("packages/backbone",function(){return t}),o("application")});